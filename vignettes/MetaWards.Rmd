---
title: "Information on MetaWards"
author: "TJ McKinley"
date: "09/06/2020"
output: html_document
---

This is a short document (not really a vignette) describing some key aspects of MetaWards that are pertinent to this UQ attempt. 

# Model description

Firstly, the current model looks like:

```{r, echo = FALSE}
library(DiagrammeR)
grViz("digraph {
  
graph[layout = dot, rankdir = LR]

node [shape = rectangle]

S
E1 [label = 'E@_{1}']
E2 [label = 'E@_{2}']
I1 [label = 'I@_{1}']
I2 [label = 'I@_{2}']
R

S -> E1 -> E2 -> I1 -> I2 -> R
}", height = '100%', width = '100%')
```

The current parameter ranges are:
\begin{align}
    \mbox{mean incubation period} &\sim U(4, 6)\\
    \mbox{mean infectious period} &\sim U(2, 4)\\
    \mbox{$R_0$} &\sim U(2.5, 4)\\
    \mbox{lockdown 1 scale} &\sim U(0, 1)\\
    \mbox{lockdown 2 scale} &\sim U(0, 1)
\end{align}
Designs generated in $(0, 1)$ or $(-1, 1)$ spaces can be easily transformed into the spaces defined above and visa-versa. Once this is done, the points on the input space must be converted to MetaWards `beta` and `progress` parameters. We use the following transformations.

## `beta` parameters

Since $I_1$ and $I_2$ are both infectious states, they have the same $\beta$ (transmission parameter). The states are indexed from 0 in MetaWards, so $\beta_2$ is the transmission parameter from the state $I_1$ and $\beta_3$ from $I_2$. These can be derived from $R_0$ and the mean infectious period as:
\begin{align}
    \beta_2 &= \frac{R_0}{\mbox{mean infectious period}}\\
    \beta_3 &= \beta_2.
\end{align}

## `progress` parameters

These are slightly trickier, because they are not *rates*, but rather are discrete-time (daily) probabilities of transition for individuals out of each class. MetaWards uses the $E_1$ and $I_1$ classes as placeholders in order to efficiently count *incidence* of new infections and infectives. Individuals automatically stay in the $E_1$ and $I_1$ classes for exactly one day, before progressing automatically to the $E_2$ and $I_2$ classes respectively. Thus:
\begin{align}
    \mbox{progress}_0 &= 1\\
    \mbox{progress}_2 &= 1.
\end{align}
(Here $\mbox{progress}_0$ is the progression probability from the $E_1 \to E_2$ class, since progression out of the $S$ class is driven by the $\beta$ terms.) Epidemiologically this has the effect of forcing the incubation period to be *at least one day*. This is adjusted for (a bit) by removing one day from the incubation and infectious periods before calculating the other progress rates. Hence:
\begin{align}
    \mbox{progress}_1 &= 1 - \exp\left(-\frac{1}{\mbox{incubation period} - 1}\right)\\
    \mbox{progress}_3 &= 1 - \exp\left(-\frac{1}{\mbox{infectious period} - 1}\right).
\end{align}
Finally, the lockdown parameters scale the force-of-infection terms (essentially the $\beta$ rates above). These are both probabilities, so don't need any additional transformations.

## Code

A short piece of R code to do the transformations from the *input* space to the *disease* inputs for MetaWards is:

```{r}
## function to convert samples to correct format for MetaWards
convertToMetaWards <- function(pars, repeats) {
    disease <- tibble(`beta[2]` = pars$r_zero / pars$infectious_time)
    disease$`beta[3]` <- disease$`beta[2]`
    disease$`progress[1]` <- 1 - exp(-(1 / (pars$incubation_time - 1)))
    disease$`progress[2]` <- 1
    disease$`progress[3]` <- 1 - exp(-(1 / (pars$infectious_time - 1)))
    disease$`.scale_rate[1]` <- pars$lock_1_restrict
    disease$`.scale_rate[2]` <- pars$lock_2_release
    disease$repeats <- repeats
    disease$par <- pars$par
    disease
}
```
where `pars` is an $(n \times 5)$ `data.frame` with each row corresponding to a design point, and columns called: `infectious_time`, `incubation_time`, `r_zero`, `lock_1_restrict` and `lock_1_release` (where the latter two are the scalings for full lockdown, and then slight lockdown release). The additional `repeats` argument adds the number of repeats to the matrix in the correct format for MetaWards.

The UQ4Covid tools automatically does this for a given design specified in $(-1, 1)$ space. **[EXAMPLE BELOW]**.

# Extended model description

We ideally want a model that incorporates moves to hospital and ICU. Here each class is split into two components, e.g. $E_1$ and $E_2$. This is so that MetaWards can calulate new movements into each class easily. Individuals progress out of the first of these classes afetr exactly one day with probability 1. This means that the time spent in each $E$, $I$, $A$ or $H$ class is *at least one day*. Here:

* $E$: infected but not infectious;
* $A$: asymptomatic and infectious;
* $I$: symptomatic and infectious;
* $H$: hospitalised and infectious;
* $C$: in critical care (ICU) and infectious;
* $R$: recovered and immune;
* $D$: died.

```{r, echo = FALSE}
library(DiagrammeR)
grViz("digraph {
  
graph[layout = dot, rankdir = LR]

node [shape = rectangle]

S
E1 [label = 'E@_{1}']
E2 [label = 'E@_{2}']
I1 [label = 'I@_{1}']
I2 [label = 'I@_{2}']
A1 [label = 'A@_{1}']
A2 [label = 'A@_{2}']
H1 [label = 'H@_{1}']
H2 [label = 'H@_{2}']
C1 [label = 'C@_{1}']
C2 [label = 'C@_{2}']
D
R

S -> E1 -> E2 -> {A1, I1}
A1 -> A2 -> R
I1 -> I2
I2 -> {H1, D, R}
H1 -> H2 -> {C1, D, R}
C1 -> C2 -> {D, R}

subgraph {
  rank = same; I1; A1;
}
subgraph {
  rank = same; I2; A2;
}

}", height = '100%', width = '100%')
```

Parameters:

* $p_{SE_1}$ driven by $\beta$ parameters, defined by $R_0$ and length of infectious period (see below);
* $p_{E_1E_2} = 1$ (probability);
* $p_{E_2A_1} = p_{EA}\left(1 - e^{-\gamma^*_{E}}\right)$ where $\gamma^*_E = \frac{1}{T_E - 1}$ with $T_E$ the mean incubation period;
* $p_{E_2I_1} = \left(1 - p_{EA}\right)\left(1 - e^{-\gamma^*_{E}}\right)$;
* $p_{A_1A_2} = 1$ (probability);
* $p_{A_2R} = 1 - e^{-\gamma^*_I}$ where $\gamma^*_I = \frac{1}{T_I - 1}$ with $T_I$ the mean infectious period;
* $p_{I_1I_2} = 1$ (probability);
* $p_{I_2H_1} = p_{IH}\left(1 - e^{-\gamma^*_{I}}\right)$ where $\delta^*_I = \frac{1}{T_I - 1}$ with $T_I$ the mean infectious period;
* $p_{I_2R} = p_{IR}\left(1 - e^{-\gamma^*_{I}}\right)$;
* $p_{I_2D} = \left(1 - p_{IH} - p_{IR}\right)\left(1 - e^{-\gamma^*_{I}}\right)$;
* $p_{H_1H_2} = 1$ (probability);
* $p_{H_2C_1} = p_{HC}\left(1 - e^{-\gamma^*_{HC}}\right)$ where $\gamma^*_{HC} = \frac{1}{T_H - T_C - 1}$ with $T_H$ the mean length of a hospital stay and $T_C$ is the mean length of time spent in ICU;
* $p_{H_2D} = p_{HD}\left(1 - e^{-\gamma^*_{H}}\right)$ where $\gamma^*_H = \frac{1}{T_H - 1}$;
* $p_{H_2R} = \left(1 - p_{HC} - p_{HD}\right)\left(1 - e^{-\gamma^*_{H}}\right)$;
* $p_{C_1C_2} = 1$ (probability);
* $p_{C_2D} = p_{CD}\left(1 - e^{-\gamma^*_{C}}\right)$ where $\gamma^*_C = \frac{1}{T_C - 1}$ with $T_C$ is the mean length of time spent in ICU;
* $p_{C_2R} = \left(1 - p_{CD}\right)\left(1 - e^{-\gamma^*_{C}}\right)$.

Lockdown can be controlled either by constraining movements over a certain distance, or by scaling the $\beta$ parameters. We do the latter at the moment.

The current parameter ranges are:
\begin{align}
    \mbox{mean incubation period} &\sim U(4, 6)\\
    \mbox{mean infectious period} &\sim U(2, 4)\\
    \mbox{$R_0$} &\sim U(2.5, 4)\\
    \mbox{lockdown 1 scale} &\sim U(0, 1)\\
    \mbox{lockdown 2 scale} &\sim U(0, 1)
\end{align}

We need: **ranges for the length of hospital stay** (perhaps chat to Rob Challen)? We could use $U(0, 1)$ ranges on many of the other parameters.

Designs generated in $(0, 1)$ or $(-1, 1)$ spaces can be easily transformed into the spaces defined above and visa-versa. Once this is done, the points on the input space must be converted to MetaWards `beta` and `progress` parameters. 

## MetaWards setup

I've taken the setup below from the `development` branch of the MetaWards tutorials. I think that to have the different epidemiological pathways we will need different sets of `.json` files e.g.

[https://metawards.org/versions/devel/tutorial/part07/01_pathways.html#modelling-a-fraction-of-asymptomatic-super-spreaders](https://metawards.org/versions/devel/tutorial/part07/01_pathways.html#modelling-a-fraction-of-asymptomatic-super-spreaders)

There are currently seven pathways, which will be described below, but summarised as:

* `asymp`: asymptomatic infections, always recover.
* `symp_R`: symptomatic infections, leading to recovery.
* `symp_D`: symptomatic infections, leading to death.
* `symp_HR`: symptomatic infections, leading to hospital and then recovery.
* `symp_HD`: symptomatic infections, leading to hospital and then death.
* `symp_HCR`: symptomatic infections, leading to hospital, then critical care (ICU) and then recovery.
* `symp_HCD`: symptomatic infections, leading to hospital, then critical care (ICU) and then death.

**[ALL NUMBERS BELOW ARE PLACEHOLDERS. THERE WOULD HAVE TO BE SWEEPS THROUGH THE DIFFERENT SETS OF PARAMETERS $p_{EA}$, $p_{IR}$ ETC. TO FEED INTO THE `demographics.json` FILE BELOW. WE NEED TO CHECK WE CAN DO SWEEPS THROUGH THE JSON FILES, ELSE WE'LL HAVE TO DESIGN SOME CUSTOMISED RUN FUNCTIONS TO ACCOMMODATE THIS.]**

**The MetaWards design is parameterised slightly differently to my attempt above. Essentially they pre-specify the proportions of individuals will belong to each possible pathway, and then randomly assign individuals to pathways once they're infected, rather than the conditional approach that I took. They're mathematically equivalent, but might be easier to parameterise on the MetaWards parameterisation, rather than conbverting between the two.**

### `demographics.json`

The `demographics.json` file should look something like:

```
{
  "demographics" : ["asymp", "symp_R", "symp_D", "symp_HR", "symp_HD", "symp_HCR", "symp_HCD"],
  "work_ratios"  : [ 0.6, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05 ],
  "play_ratios"  : [ 0.6, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05 ],
  "diseases"     : ["ncov_asymp", "ncov_symp_R", "ncov_symp_D", "ncov_symp_HR", "ncov_symp_HCR", "ncov_symp_HCR", "ncov_symp_HCD"]
}
```

The ratios are the ratios of individuals that would belong to each pathway.

### Pathways `.json` files

We need different disease `.json` files for the different pathways.

#### `asymp`

The asymptomatic pathway (from above) is:

```{r, echo = FALSE}
grViz("digraph {
  
graph[layout = dot, rankdir = LR]

node [shape = rectangle]

S
E1 [label = 'E@_{1}']
E2 [label = 'E@_{2}']
A1 [label = 'A@_{1}']
A2 [label = 'A@_{2}']
R

S -> E1 -> E2 -> A1 -> A2 -> R
}", height = '100%', width = '100%')
```

Hence we need `ncov_asymp.json`:

```
{ "name"             : "SARS-Cov-2 - asymptomatic pathway",
  "version"          : "June 9th 2020",
  "author(s)"        : "UQ4COVID Team",
  "contact(s)"       : "e-mail...",
  "reference(s)"     : "references...",  
  "beta"             : [0.0, 0.0, 1.0, 1.0, 0.0],
  "progress"         : [1.0, 1.0, 1.0, 1.0, 0.0],
  "too_ill_to_move"  : [0.0, 0.0, 0.0, 0.0, 0.0],
  "contrib_foi"      : [1.0, 1.0, 1.0, 1.0, 0.0]
}
```

> **Note:** We would want asymptomatics to be less infectious than symptomatics, so could amend $\beta$, or set `contrib_foi`?

#### `symp_R`

The symptomatic/recovered pathway (from above) is:

```{r, echo = FALSE}
grViz("digraph {
  
graph[layout = dot, rankdir = LR]

node [shape = rectangle]

S
E1 [label = 'E@_{1}']
E2 [label = 'E@_{2}']
I1 [label = 'I@_{1}']
I2 [label = 'I@_{2}']
R

S -> E1 -> E2 -> I1 -> I2 -> R
}", height = '100%', width = '100%')
```

Hence we need `ncov_symp_R.json`:

```
{ "name"             : "SARS-Cov-2 - symptomatic/recovered pathway",
  "version"          : "June 9th 2020",
  "author(s)"        : "UQ4COVID Team",
  "contact(s)"       : "e-mail...",
  "reference(s)"     : "references...",  
  "beta"             : [0.0, 0.0, 1.0, 1.0, 0.0],
  "progress"         : [1.0, 1.0, 1.0, 1.0, 0.0],
  "too_ill_to_move"  : [0.0, 0.0, 0.0, 0.0, 0.0],
  "contrib_foi"      : [1.0, 1.0, 1.0, 1.0, 0.0]
}
```

#### `symp_D`

The symptomatic/dead pathway (from above) is:

```{r, echo = FALSE}
grViz("digraph {
  
graph[layout = dot, rankdir = LR]

node [shape = rectangle]

S
E1 [label = 'E@_{1}']
E2 [label = 'E@_{2}']
I1 [label = 'I@_{1}']
I2 [label = 'I@_{2}']
D

S -> E1 -> E2 -> I1 -> I2 -> D
}", height = '100%', width = '100%')
```

Hence we need `ncov_symp_D.json`:

```
{ "name"             : "SARS-Cov-2 - symptomatic/dead pathway",
  "version"          : "June 9th 2020",
  "author(s)"        : "UQ4COVID Team",
  "contact(s)"       : "e-mail...",
  "reference(s)"     : "references...",  
  "beta"             : [0.0, 0.0, 1.0, 1.0, 0.0],
  "progress"         : [1.0, 1.0, 1.0, 1.0, 0.0],
  "too_ill_to_move"  : [0.0, 0.0, 0.0, 0.0, 0.0],
  "contrib_foi"      : [1.0, 1.0, 1.0, 1.0, 0.0]
}
```

> **Note**: not quite sure how to differentiate recovereds from dead, usually the latter would not contribute to the population sizes going forward, though the former would. In this case since populations are relatively large it will make little difference, so the `symp_R` and `symp_D` pathways would have the same parameters, but would be differentiated as a straightforward way to extract death counts for e.g. calibration.

#### `symp_HR`

The symptomatic/hospital/recovered pathway (from above) is:

```{r, echo = FALSE}
grViz("digraph {
  
graph[layout = dot, rankdir = LR]

node [shape = rectangle]

S
E1 [label = 'E@_{1}']
E2 [label = 'E@_{2}']
I1 [label = 'I@_{1}']
I2 [label = 'I@_{2}']
H1 [label = 'H@_{1}']
H2 [label = 'H@_{2}']
R

S -> E1 -> E2 -> I1 -> I2 -> H1 -> H2 -> R
}", height = '100%', width = '100%')
```

Hence we need `ncov_symp_HR.json`:

```
{ "name"             : "SARS-Cov-2 - symptomatic/hospital/recovered pathway",
  "version"          : "June 9th 2020",
  "author(s)"        : "UQ4COVID Team",
  "contact(s)"       : "e-mail...",
  "reference(s)"     : "references...",  
  "beta"             : [0.0, 0.0, 1.0, 1.0, 1.0, 1.0, 0.0],
  "progress"         : [1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0],
  "too_ill_to_move"  : [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  "contrib_foi"      : [1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0]
}
```

#### `symp_HD`

The symptomatic/hospital/death pathway (from above) is:

```{r, echo = FALSE}
grViz("digraph {
  
graph[layout = dot, rankdir = LR]

node [shape = rectangle]

S
E1 [label = 'E@_{1}']
E2 [label = 'E@_{2}']
I1 [label = 'I@_{1}']
I2 [label = 'I@_{2}']
H1 [label = 'H@_{1}']
H2 [label = 'H@_{2}']
D

S -> E1 -> E2 -> I1 -> I2 -> H1 -> H2 -> D
}", height = '100%', width = '100%')
```

Hence we need `ncov_symp_HD.json`:

```
{ "name"             : "SARS-Cov-2 - symptomatic/hospital/dead pathway",
  "version"          : "June 9th 2020",
  "author(s)"        : "UQ4COVID Team",
  "contact(s)"       : "e-mail...",
  "reference(s)"     : "references...",  
  "beta"             : [0.0, 0.0, 1.0, 1.0, 1.0, 1.0, 0.0],
  "progress"         : [1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0],
  "too_ill_to_move"  : [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  "contrib_foi"      : [1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0]
}
```

> **Note**: see `symp_R` and `symp_D` note from earlier.

#### `symp_HCR`

The symptomatic/hospital/ICU/recovered pathway (from above) is:

```{r, echo = FALSE}
grViz("digraph {
  
graph[layout = dot, rankdir = LR]

node [shape = rectangle]

S
E1 [label = 'E@_{1}']
E2 [label = 'E@_{2}']
I1 [label = 'I@_{1}']
I2 [label = 'I@_{2}']
H1 [label = 'H@_{1}']
H2 [label = 'H@_{2}']
C1 [label = 'C@_{1}']
C2 [label = 'C@_{2}']
R

S -> E1 -> E2 -> I1 -> I2 -> H1 -> H2 -> C1 -> C2 -> R
}", height = '100%', width = '100%')
```

Hence we need `ncov_symp_HCR.json`:

```
{ "name"             : "SARS-Cov-2 - symptomatic/hospital/ICU/recovered pathway",
  "version"          : "June 9th 2020",
  "author(s)"        : "UQ4COVID Team",
  "contact(s)"       : "e-mail...",
  "reference(s)"     : "references...",  
  "beta"             : [0.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0],
  "progress"         : [1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0],
  "too_ill_to_move"  : [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  "contrib_foi"      : [1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0]
}
```

#### `symp_HCD`

The symptomatic/hospital/ICU/dead pathway (from above) is:

```{r, echo = FALSE}
grViz("digraph {
  
graph[layout = dot, rankdir = LR]

node [shape = rectangle]

S
E1 [label = 'E@_{1}']
E2 [label = 'E@_{2}']
I1 [label = 'I@_{1}']
I2 [label = 'I@_{2}']
H1 [label = 'H@_{1}']
H2 [label = 'H@_{2}']
C1 [label = 'C@_{1}']
C2 [label = 'C@_{2}']
D

S -> E1 -> E2 -> I1 -> I2 -> H1 -> H2 -> C1 -> C2 -> D
}", height = '100%', width = '100%')
```

Hence we need `ncov_symp_HCD.json`:

```
{ "name"             : "SARS-Cov-2 - symptomatic/hospital/ICU/dead pathway",
  "version"          : "June 9th 2020",
  "author(s)"        : "UQ4COVID Team",
  "contact(s)"       : "e-mail...",
  "reference(s)"     : "references...",  
  "beta"             : [0.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0],
  "progress"         : [1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0],
  "too_ill_to_move"  : [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  "contrib_foi"      : [1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0]
}
```

> **Note**: see `symp_R` and `symp_D` note from earlier.

### Interaction matrices

**NEED TO FIGURE THIS OUT.**

Set up the **interaction matrix** as e.g. `hospitals.py`:

```
from metawards.mixers import merge_using_matrix

def mix_shield(network, **kwargs):
    matrix = [ [0.2, 0.1],
               [0.8, 1.0] ]

    network.demographics.interaction_matrix = matrix

    return [merge_using_matrix]
```
